<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Instrument Tuner</title>
    <style>
        :root {
            --primary: #008844;
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
            --danger: #ff4444;
            --headstock: #332211;
            --peg-idle: #444;
        }

        body.light-mode {
            --primary: #6200ea;
            --bg: #f0f0f0;
            --card: #ffffff;
            --text: #121212;
            --headstock: #5d4037;
            --peg-idle: #bdbdbd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; background: var(--bg); color: var(--text);
            transition: background 0.3s, color 0.3s; overflow: hidden;
        }

        .container {
            text-align: center; background: var(--card); padding: 2rem;
            border-radius: 24px; width: 320px; border: 1px solid rgba(128,128,128,0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }

        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        #themeToggle {
            background: rgba(128,128,128,0.15); border: none; color: var(--text); padding: 8px 12px;
            border-radius: 8px; cursor: pointer; font-size: 1rem;
        }

        .mode-switch { display: flex; background: rgba(128,128,128,0.1); border-radius: 12px; padding: 4px; flex-grow: 1; margin-right: 10px; }
        .mode-btn { flex: 1; padding: 8px; border: none; background: none; color: #888; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .mode-btn.active { background: var(--primary); color: #fff; }

        select {
            width: 100%; background: rgba(128,128,128,0.05); color: var(--text);
            border: 1px solid rgba(128,128,128,0.2); padding: 12px; border-radius: 12px;
            margin-bottom: 15px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
        }

        .headstock-container { height: 160px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        svg { height: 100%; }
        .peg { fill: var(--peg-idle); cursor: pointer; transition: fill 0.2s; }
        .peg.active { fill: var(--primary); filter: drop-shadow(0 0 5px var(--primary)); }
        .head-shape { fill: var(--headstock); stroke: rgba(0,0,0,0.2); stroke-width: 1; transition: fill 0.3s; }
        .label { fill: #888; font-size: 10px; font-weight: bold; pointer-events: none; }

        .note { font-size: 5rem; font-weight: 900; line-height: 1; margin: 5px 0; height: 85px; transition: color 0.2s; }
        .meter { width: 100%; height: 8px; background: rgba(128,128,128,0.2); border-radius: 4px; margin: 15px 0; position: relative; overflow: hidden; }
        .needle { width: 4px; height: 100%; background: var(--danger); position: absolute; left: 50%; transform: translateX(-50%); transition: background 0.2s; }

        #startBtn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-controls">
        <div class="mode-switch">
            <button id="btn-guitar" class="mode-btn" onclick="setInstrument('guitar')">Guitar</button>
            <button id="btn-ukulele" class="mode-btn" onclick="setInstrument('ukulele')">Uke</button>
        </div>
        <button id="themeToggle" onclick="toggleTheme()">üåô</button>
    </div>

    <select id="tuningSelect" onchange="changeTuning()"></select>

    <div class="headstock-container" id="svgContainer"></div>

    <div id="tuner-ui" class="hidden">
        <div id="note" class="note">--</div>
        <div class="meter"><div id="needle" class="needle"></div></div>
    </div>

    <button id="startBtn">START TUNER</button>
</div>

<script>
    let instrument = 'guitar';
    let tuningKey = 'standard';
    const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    const tunings = {
        guitar: {
            standard: { name: "Standard (EADGBE)", notes: [40, 45, 50, 64, 59, 55], labels: ["E","A","D","E","B","G"], freqs: [82.41, 110, 146.83, 329.63, 246.94, 196] },
            dropD: { name: "Drop D (DADGBE)", notes: [38, 45, 50, 64, 59, 55], labels: ["D","A","D","E","B","G"], freqs: [73.42, 110, 146.83, 329.63, 246.94, 196] },
            openG: { name: "Open G (DGDGBD)", notes: [38, 43, 50, 62, 59, 55], labels: ["D","G","D","D","B","G"], freqs: [73.42, 98, 146.83, 293.66, 246.94, 196] }
        },
        ukulele: {
            standard: { name: "Standard (GCEA)", notes: [67, 60, 69, 64], labels: ["G","C","A","E"], freqs: [392, 261.63, 440, 329.63] },
            lowG: { name: "Low G (GCEA)", notes: [55, 60, 69, 64], labels: ["G","C","A","E"], freqs: [196, 261.63, 440, 329.63] }
        }
    };

    let audioCtx, analyser, smoothedDiff = 0, inTuneTimer = 0, lastChimeTime = 0;

    function savePreferences() {
        localStorage.setItem('tunerPrefsFinalV3', JSON.stringify({ instrument, tuningKey, lightMode: document.body.classList.contains('light-mode') }));
    }

    function loadPreferences() {
        const saved = JSON.parse(localStorage.getItem('tunerPrefsFinalV3') || '{}');
        if (saved.lightMode) { document.body.classList.add('light-mode'); document.getElementById('themeToggle').innerText = "‚òÄÔ∏è"; }
        instrument = saved.instrument || 'guitar';
        tuningKey = saved.tuningKey || 'standard';
        updateUI();
    }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        document.getElementById('themeToggle').innerText = document.body.classList.contains('light-mode') ? "‚òÄÔ∏è" : "üåô";
        savePreferences();
    }

    function setInstrument(inst) {
        instrument = inst;
        tuningKey = 'standard';
        updateUI();
        savePreferences();
    }

    function changeTuning() {
        tuningKey = document.getElementById('tuningSelect').value;
        updateUI();
        savePreferences();
    }

    function updateUI() {
        document.getElementById('btn-guitar').classList.toggle('active', instrument === 'guitar');
        document.getElementById('btn-ukulele').classList.toggle('active', instrument === 'ukulele');

        const select = document.getElementById('tuningSelect');
        select.innerHTML = '';
        for (let key in tunings[instrument]) {
            let opt = document.createElement('option');
            opt.value = key;
            opt.innerText = tunings[instrument][key].name;
            if (key === tuningKey) opt.selected = true;
            select.appendChild(opt);
        }

        const config = tunings[instrument][tuningKey];
        const container = document.getElementById('svgContainer');

        if (instrument === 'guitar') {
            container.innerHTML = `
                <svg viewBox="0 0 100 150">
                    <path class="head-shape" d="M30,140 L70,140 L80,30 Q80,10 50,10 Q20,10 20,30 Z" />
                    <circle id="peg-${config.notes[0]}" class="peg" cx="25" cy="115" r="6.5" onclick="playTone(${config.freqs[0]})" /> <text x="8" y="118.5" text-anchor="end" class="label">${config.labels[0]}</text>
                    <circle id="peg-${config.notes[1]}" class="peg" cx="25" cy="77" r="6.5" onclick="playTone(${config.freqs[1]})" /> <text x="8" y="80.5" text-anchor="end" class="label">${config.labels[1]}</text>
                    <circle id="peg-${config.notes[2]}" class="peg" cx="25" cy="39" r="6.5" onclick="playTone(${config.freqs[2]})" /> <text x="8" y="42.5" text-anchor="end" class="label">${config.labels[2]}</text>
                    <circle id="peg-${config.notes[3]}" class="peg" cx="75" cy="115" r="6.5" onclick="playTone(${config.freqs[3]})" /> <text x="92" y="118.5" text-anchor="start" class="label">${config.labels[3]}</text>
                    <circle id="peg-${config.notes[4]}" class="peg" cx="75" cy="77" r="6.5" onclick="playTone(${config.freqs[4]})" /> <text x="92" y="80.5" text-anchor="start" class="label">${config.labels[4]}</text>
                    <circle id="peg-${config.notes[5]}" class="peg" cx="75" cy="39" r="6.5" onclick="playTone(${config.freqs[5]})" /> <text x="92" y="42.5" text-anchor="start" class="label">${config.labels[5]}</text>
                </svg>`;
        } else {
            container.innerHTML = `
                <svg viewBox="0 0 100 150">
                    <path class="head-shape" d="M35,140 L65,140 L75,40 Q75,15 50,15 Q25,15 25,40 Z" />
                    <circle id="peg-${config.notes[0]}" class="peg" cx="30" cy="90" r="7.5" onclick="playTone(${config.freqs[0]})" /> <text x="12" y="94" class="label">${config.labels[0]}</text>
                    <circle id="peg-${config.notes[1]}" class="peg" cx="30" cy="50" r="7.5" onclick="playTone(${config.freqs[1]})" /> <text x="12" y="54" class="label">${config.labels[1]}</text>
                    <circle id="peg-${config.notes[2]}" class="peg" cx="70" cy="90" r="7.5" onclick="playTone(${config.freqs[2]})" /> <text x="80" y="94" class="label">${config.labels[2]}</text>
                    <circle id="peg-${config.notes[3]}" class="peg" cx="70" cy="50" r="7.5" onclick="playTone(${config.freqs[3]})" /> <text x="80" y="54" class="label">${config.labels[3]}</text>
                </svg>`;
        }
    }

    function playTone(freq, isChime = false) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = isChime ? 'sine' : 'triangle';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(isChime ? 0.1 : 0.15, audioCtx.currentTime + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (isChime ? 0.6 : 1.2));
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 1.5);
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false } });
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 4096;
            source.connect(analyser);
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('tuner-ui').classList.remove('hidden');
            updatePitch();
        } catch (err) { alert("Microphone access is required."); }
    });

    function updatePitch() {
        const buffer = new Float32Array(analyser.fftSize);
        analyser.getFloatTimeDomainData(buffer);
        const pitch = autoCorrelate(buffer, audioCtx.sampleRate);
        const needle = document.getElementById('needle');

        if (pitch !== -1) {
            const noteIndex = 12 * (Math.log(pitch / 440) / Math.log(2)) + 69;
            const rounded = Math.round(noteIndex);
            const diff = noteIndex - rounded;
            smoothedDiff += (diff - smoothedDiff) * 0.15;

            document.getElementById('note').innerText = noteStrings[rounded % 12];
            needle.style.left = `${50 + (smoothedDiff * 100)}%`;

            document.querySelectorAll('.peg').forEach(p => p.classList.remove('active'));
            const config = tunings[instrument][tuningKey];
            if (config.notes.includes(rounded)) {
                const activePeg = document.getElementById(`peg-${rounded}`);
                if (activePeg) activePeg.classList.add('active');
            }

            const inTune = Math.abs(diff) < 0.05;
            if (inTune) {
                needle.style.background = "var(--primary)";
                document.getElementById('note').style.color = "var(--primary)";
                inTuneTimer++;
                if (inTuneTimer > 30 && (Date.now() - lastChimeTime > 2500)) {
                    playTone(880, true);
                    lastChimeTime = Date.now();
                }
            } else {
                needle.style.background = "var(--danger)";
                document.getElementById('note').style.color = "var(--text)";
                inTuneTimer = 0;
            }
        }
        requestAnimationFrame(updatePitch);
    }

    function autoCorrelate(buffer, sampleRate) {
        let rms = 0;
        for (let i = 0; i < buffer.length; i++) rms += buffer[i] * buffer[i];
        if (Math.sqrt(rms / buffer.length) < 0.005) return -1;
        let c = new Float32Array(buffer.length).fill(0);
        for (let i = 0; i < buffer.length; i++) {
            for (let j = 0; j < buffer.length - i; j++) c[i] = c[i] + buffer[j] * buffer[j + i];
        }
        let d = 0; while (c[d] > c[d + 1]) d++;
        let maxval = -1, maxpos = -1;
        for (let i = d; i < buffer.length; i++) {
            if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
        }
        return sampleRate / maxpos;
    }

    loadPreferences();
</script>
</body>
</html>
